module Sound where

import Control.Monad.Eff

foreign import data Sound :: !

data SoundEffect = Quiet
                 | Sound String
                 | ExclusiveSound String
                 | RepeatSound String

foreign import play """
  var play = (function() {
    var ctx = new (window.AudioContext || window.webkitAudioContext)();
    var active = [];
    function play(o) {
      return function() {
        if (o.value0) {
          if (o instanceof ExclusiveSound) {
            active.map(function(i) {
              i.el.pause();
              i.src.disconnect();
            });
            active = [];
          }
          var el = new Audio(o.value0);
          var src = ctx.createMediaElementSource(el);
          el.addEventListener("ended", function(e) {
            src.disconnect();
            active = active.filter(function(i) { return i.el !== e.target });
          });
          if (o instanceof RepeatSound) el.loop = true;
          src.connect(ctx.destination);
          el.play();
          active.push({el: el, src: src});
        }
      };
    }
    return play;
  })();""" :: forall e. SoundEffect -> Eff (sound :: Sound | e) Unit
